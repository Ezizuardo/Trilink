{% extends "base.html" %}
{% block title %}{{ t('profile_title') }}{% endblock %}
{% block content %}
<h1><span class="icon icon-profile"></span>{{ t('profile_title') }}</h1>
<section class="card profile-card">
  <div class="profile-avatar">
    <img class="avatar" src="{{ avatar }}" alt="avatar">
  </div>
  <div class="profile-main">
    <h2>{{ user.first_name or 'Без имени' }} {{ user.last_name or '' }}</h2>
    <div class="muted">@{{ user.nickname or 'без_ника' }} · {{ 'Специалист' if user.role=='specialist' else 'Ученик' }}</div>
    <div class="profile-meta">
      <div><span class="label">Возраст</span><span class="value">{{ user.age or '—' }}</span></div>
      <div><span class="label">Образование</span><span class="value">{{ user.education or '—' }}</span></div>
      <div><span class="label">Год выпуска</span><span class="value">{{ user.graduation_year or '—' }}</span></div>
    </div>
    <div class="profile-tabs">
      <a class="tab {{ 'active' if tab=='summary' else '' }}" href="{{ url_for('profile') }}">Обзор</a>
      <a class="tab {{ 'active' if tab=='about' else '' }}" href="{{ url_for('profile', tab='about') }}">О себе</a>
      <a class="tab {{ 'active' if tab=='course' else '' }}" href="{{ url_for('profile', tab='course') }}">Мой курс</a>
    </div>
  </div>
</section>

{% if tab == 'about' %}
<form class="card profile-form" method="post" enctype="multipart/form-data">
  <input type="hidden" name="action" value="about">
  <div class="grid-2">
    <label class="field">
      <span>Имя</span>
      <input name="first_name" value="{{ user.first_name or '' }}" placeholder="Имя">
    </label>
    <label class="field">
      <span>Фамилия</span>
      <input name="last_name" value="{{ user.last_name or '' }}" placeholder="Фамилия">
    </label>
    <label class="field">
      <span>Никнейм</span>
      <input name="nickname" value="{{ user.nickname or '' }}" placeholder="@nickname">
    </label>
    <label class="field">
      <span>Ник в Telegram</span>
      <input name="telegram" value="{{ user.telegram or '' }}" placeholder="@telegram" required>
    </label>
    <label class="field">
      <span>Возраст</span>
      <input name="age" value="{{ user.age or '' }}" placeholder="18" inputmode="numeric">
    </label>
    <label class="field">
      <span>Образование</span>
      <input name="education" value="{{ user.education or '' }}" placeholder="Учебное заведение">
    </label>
    <label class="field">
      <span>Год выпуска</span>
      <input name="graduation_year" value="{{ user.graduation_year or '' }}" placeholder="2025" inputmode="numeric">
    </label>
  </div>
  <div class="file-row">
    <label class="file-btn">
      <span class="btn outline">Загрузить аватар</span>
      <input type="file" name="avatar" accept="image/*">
    </label>
    <span class="muted">Форматы: png, jpg, jpeg, gif, webp</span>
  </div>
  <div class="profile-note">
    <strong>Почта:</strong> {{ user.email }} <span class="muted">(видно только вам)</span>
  </div>
  <div class="form-actions">
    <button class="btn strong" type="submit">Сохранить</button>
    <button class="btn outline" type="submit" name="cancel" value="1">Отмена</button>
  </div>
</form>
{% elif tab == 'course' %}
  {% if user.role == 'specialist' %}
<section class="card course-manage">
  <div class="course-manage-header">
    <div>
      <h3>Мои интенсивы</h3>
      <p class="muted">Редактируйте существующие плейлисты и добавляйте новые материалы в пару кликов.</p>
    </div>
    <a class="btn strong" href="{{ url_for('course_create') }}">Добавить курс</a>
  </div>
  {% if courses %}
  <div class="course-manage-grid">
    {% for item in courses %}
      {% set course = item.course %}
      <article class="course-manage-card">
        <a class="course-manage-cover" href="{{ item.public_url }}" target="_blank">
          <div class="course-thumb" {% if course.cover_image %}style="background-image:url('{{ course.cover_image }}')"{% endif %}>
            {% if item.video_count %}<span class="course-count">{{ item.video_count }} видео</span>{% endif %}
            {% if course.price is not none %}<span class="price-tag">{{ format_price(course.price) }}</span>{% endif %}
          </div>
        </a>
        <div class="course-manage-body">
          <div class="course-manage-info">
            <h4>{{ course.title }}</h4>
            <p class="muted">{{ course.subject or 'Без предмета' }}{% if course.topic %} · {{ course.topic }}{% endif %}</p>
          </div>
          <div class="course-manage-actions">
            <a class="btn strong" href="{{ item.edit_url }}">Редактировать</a>
            <a class="btn outline" href="{{ item.public_url }}" target="_blank">Открыть</a>
          </div>
        </div>
      </article>
    {% endfor %}
  </div>
  {% else %}
  <div class="course-empty">
    <p>Курсы пока не добавлены.</p>
    <a class="btn outline" href="{{ url_for('course_create') }}">Создать первый курс</a>
  </div>
  {% endif %}
</section>
  {% else %}
<section class="card course-manage">
  <div class="course-manage-header">
    <div>
      <h3>Оплаченные интенсивы</h3>
      <p class="muted">Здесь отображаются интенсивы специалистов, к которым у вас есть доступ.</p>
    </div>
  </div>
  {% if purchased_courses %}
  <div class="course-manage-grid">
    {% for item in purchased_courses %}
      {% set course = item.course %}
      <article class="course-manage-card">
        <a class="course-manage-cover" href="{{ item.public_url }}" target="_blank">
          <div class="course-thumb" {% if course.cover_image %}style="background-image:url('{{ course.cover_image }}')"{% endif %}>
            {% if item.video_count %}<span class="course-count">{{ item.video_count }} видео</span>{% endif %}
            {% if course.price is not none %}<span class="price-tag">{{ format_price(course.price) }}</span>{% endif %}
          </div>
        </a>
        <div class="course-manage-body">
          <div class="course-manage-info">
            <h4>{{ course.title }}</h4>
            <p class="muted">Специалист: {{ item.teacher.first_name or item.teacher.nickname or item.teacher.email }}</p>
          </div>
          <div class="course-manage-actions">
            <a class="btn strong" href="{{ item.public_url }}" target="_blank">Перейти к курсу</a>
          </div>
        </div>
      </article>
    {% endfor %}
  </div>
  {% else %}
  <div class="course-empty">
    <p>После оплаты здесь появятся ваши интенсивы.</p>
    <a class="btn outline" href="{{ url_for('search') }}">Найти курс</a>
  </div>
  {% endif %}
</section>
  {% endif %}
{% else %}
<section class="card profile-overview">
  <h3>О себе</h3>
  <p>Имя: <strong>{{ user.first_name or '—' }}</strong></p>
  <p>Фамилия: <strong>{{ user.last_name or '—' }}</strong></p>
  <p>Ник: <strong>@{{ user.nickname or '—' }}</strong></p>
  <p>Телеграм: <strong>{{ user.telegram or '—' }}</strong></p>
  <p>Возраст: <strong>{{ user.age or '—' }}</strong></p>
  <p>Образование: <strong>{{ user.education or '—' }}</strong></p>
  <p>Год выпуска: <strong>{{ user.graduation_year or '—' }}</strong></p>
  <p>Почта: <strong>{{ user.email }}</strong> <span class="muted">(видно только вам)</span></p>
  <div class="course-preview">
    <h3>{{ 'Мои интенсивы' if user.role == 'specialist' else 'Оплаченные интенсивы' }}</h3>
    {% if user.role == 'specialist' %}
      {% if courses %}
      <div class="course-grid">
        {% for item in courses %}
          {% set course = item.course %}
          <a class="course-card-mini compact" href="{{ item.public_url }}" target="_blank">
            <div class="course-thumb" {% if course.cover_image %}style="background-image:url('{{ course.cover_image }}')"{% endif %}>
              {% if item.video_count %}<span class="course-count">{{ item.video_count }} видео</span>{% endif %}
              {% if course.price is not none %}<span class="price-tag">{{ format_price(course.price) }}</span>{% endif %}
            </div>
            <div class="course-info">
              <h4>{{ course.title }}</h4>
              <p class="muted">{{ course.subject or 'Без предмета' }}{% if course.topic %} · {{ course.topic }}{% endif %}</p>
            </div>
          </a>
        {% endfor %}
      </div>
      {% else %}
      <div class="course-placeholder">Курсы пока не добавлены.</div>
      {% endif %}
    {% else %}
      {% if purchased_courses %}
      <div class="course-grid">
        {% for item in purchased_courses %}
          {% set course = item.course %}
          <a class="course-card-mini compact" href="{{ item.public_url }}" target="_blank">
            <div class="course-thumb" {% if course.cover_image %}style="background-image:url('{{ course.cover_image }}')"{% endif %}>
              {% if item.video_count %}<span class="course-count">{{ item.video_count }} видео</span>{% endif %}
              {% if course.price is not none %}<span class="price-tag">{{ format_price(course.price) }}</span>{% endif %}
            </div>
            <div class="course-info">
              <h4>{{ course.title }}</h4>
              <p class="muted">Специалист: {{ item.teacher.first_name or item.teacher.nickname or item.teacher.email }}</p>
            </div>
          </a>
        {% endfor %}
      </div>
      {% else %}
      <div class="course-placeholder">Вы ещё не приобрели интенсивы.</div>
      {% endif %}
    {% endif %}
  </div>
</section>
{% endif %}
{% endblock %}
