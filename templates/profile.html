{% extends "base.html" %}
{% block title %}{{ t('profile_title') }}{% endblock %}
{% block content %}
<h1><span class="icon icon-profile"></span>{{ t('profile_title') }}</h1>
<section class="card profile-card">
  <div class="profile-avatar">
    <img class="avatar" src="{{ avatar }}" alt="avatar">
  </div>
  <div class="profile-main">
    <h2>{{ user.first_name or 'Без имени' }} {{ user.last_name or '' }}</h2>
    <div class="muted">@{{ user.nickname or 'без_ника' }} · {{ 'Специалист' if user.role=='specialist' else 'Ученик' }}</div>
    <div class="profile-meta">
      <div><span class="label">Возраст</span><span class="value">{{ user.age or '—' }}</span></div>
      <div><span class="label">Образование</span><span class="value">{{ user.education or '—' }}</span></div>
      <div><span class="label">Год выпуска</span><span class="value">{{ user.graduation_year or '—' }}</span></div>
      <div><span class="label">Телеграм</span><span class="value">{{ user.telegram_handle or '—' }}</span></div>
    </div>
    <div class="profile-tabs">
      <a class="tab {{ 'active' if tab=='summary' else '' }}" href="{{ url_for('profile') }}">Обзор</a>
      <a class="tab {{ 'active' if tab=='about' else '' }}" href="{{ url_for('profile', tab='about') }}">О себе</a>
      <a class="tab {{ 'active' if tab=='course' else '' }}" href="{{ url_for('profile', tab='course') }}">Мой курс</a>
    </div>
  </div>
</section>

{% if tab == 'about' %}
<form class="card profile-form" method="post" enctype="multipart/form-data">
  <input type="hidden" name="action" value="about">
  <div class="grid-2">
    <label class="field">
      <span>Имя</span>
      <input name="first_name" value="{{ user.first_name or '' }}" placeholder="Имя">
    </label>
    <label class="field">
      <span>Фамилия</span>
      <input name="last_name" value="{{ user.last_name or '' }}" placeholder="Фамилия">
    </label>
    <label class="field">
      <span>Никнейм</span>
      <input name="nickname" value="{{ user.nickname or '' }}" placeholder="@nickname">
    </label>
    <label class="field">
      <span>Возраст</span>
      <input name="age" value="{{ user.age or '' }}" placeholder="18" inputmode="numeric">
    </label>
    <label class="field">
      <span>Образование</span>
      <input name="education" value="{{ user.education or '' }}" placeholder="Учебное заведение">
    </label>
    <label class="field">
      <span>Год выпуска</span>
      <input name="graduation_year" value="{{ user.graduation_year or '' }}" placeholder="2025" inputmode="numeric">
    </label>
    <label class="field">
      <span>Телеграм</span>
      <input name="telegram_handle" value="{{ user.telegram_handle or '' }}" placeholder="@username" required>
    </label>
    <label class="field">
      <span>Email (виден только вам)</span>
      <input value="{{ user.email }}" readonly>
    </label>
  </div>
  <div class="file-row">
    <label class="file-btn">
      <span class="btn outline">Загрузить аватар</span>
      <input type="file" name="avatar" accept="image/*">
    </label>
    <span class="muted">Форматы: png, jpg, jpeg, gif, webp</span>
  </div>
  <div class="form-actions">
    <button class="btn strong" type="submit">Сохранить</button>
    <button class="btn outline" type="submit" name="cancel" value="1">Отмена</button>
  </div>
</form>
{% elif tab == 'course' %}
<section class="card course-manage">
  {% if course %}
  <div class="course-manage-hero">
    <div class="course-thumb" style="background-image:url('{{ course.preview_image or '/static/img/course_placeholder.svg' }}')"></div>
    <div class="course-manage-info">
      <div class="course-manage-top">
        <h3>{{ course.title }}</h3>
        {% if course.price is not none %}
        <span class="price-badge">{{ "{:,.0f}".format(course.price).replace(',', ' ') }} ₽</span>
        {% endif %}
      </div>
      <div class="course-tags">
        {% if course.subject %}<span class="chip">{{ course.subject }}</span>{% endif %}
        {% if course.topic %}<span class="chip">{{ course.topic }}</span>{% endif %}
        <span class="chip muted">{{ course_videos|length }} видео</span>
      </div>
      <p class="muted">{{ course.description or 'Добавьте описание интенсива, чтобы ученики понимали, что их ждёт.' }}</p>
      <div class="course-manage-actions">
        <a class="btn strong" href="{{ url_for('course_detail', course_id=course.id) }}">Открыть курс</a>
        <a class="btn outline" href="{{ url_for('course_new') }}">Редактировать</a>
      </div>
    </div>
  </div>
  <div class="playlist-mini">
    <h4>Плейлист</h4>
    <ol>
      {% for video in course_videos %}
      <li>
        <span class="mini-number">{{ loop.index }}</span>
        <div class="mini-body">
          <div class="mini-title">{{ video.title or 'Видео урок' }}</div>
          <div class="mini-meta">{{ ('%.2f' % (video.file_size_mb or 0))|replace('.', ',') }} МБ</div>
        </div>
      </li>
      {% else %}
      <li class="muted">Видео пока нет. Загрузите их на странице редактирования.</li>
      {% endfor %}
    </ol>
  </div>
  {% else %}
  <div class="course-placeholder large">Курс ещё не создан</div>
  <p class="muted">Добавьте превью, описание и загрузите уроки, чтобы курс появился в поиске.</p>
  {% endif %}
  <div class="form-actions align-start">
    <a class="btn strong" href="{{ url_for('course_new') }}">Добавить курс</a>
  </div>
</section>
{% else %}
<section class="card profile-overview">
  <h3>О себе</h3>
  <p>Имя: <strong>{{ user.first_name or '—' }}</strong></p>
  <p>Фамилия: <strong>{{ user.last_name or '—' }}</strong></p>
  <p>Ник: <strong>@{{ user.nickname or '—' }}</strong></p>
  <p>Возраст: <strong>{{ user.age or '—' }}</strong></p>
  <p>Образование: <strong>{{ user.education or '—' }}</strong></p>
  <p>Год выпуска: <strong>{{ user.graduation_year or '—' }}</strong></p>
  <p>Телеграм: <strong>{{ user.telegram_handle or '—' }}</strong></p>
  <p>Email: <strong>{{ user.email }}</strong></p>
  <div class="course-preview">
    <h3>Мой курс</h3>
    {% if course %}
      <a class="course-card" href="{{ url_for('course_detail', course_id=course.id) }}">
        <div class="course-card-cover" style="background-image:url('{{ course.preview_image or '/static/img/course_placeholder.svg' }}')"></div>
        <div class="course-card-body">
          <div class="course-card-top">
            <h4>{{ course.title }}</h4>
            {% if course.price is not none %}<span class="price-badge">{{ "{:,.0f}".format(course.price).replace(',', ' ') }} ₽</span>{% endif %}
          </div>
          <div class="course-card-meta">
            {% if course.subject %}<span>{{ course.subject }}</span>{% endif %}
            {% if course.topic %}<span>{{ course.topic }}</span>{% endif %}
            <span>{{ course_videos|length }} видео</span>
          </div>
        </div>
      </a>
    {% else %}
      <div class="course-placeholder">Курса пока нет</div>
    {% endif %}
  </div>
</section>
{% endif %}
{% endblock %}
