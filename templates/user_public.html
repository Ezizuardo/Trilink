{% extends "base.html" %}
{% block title %}Профиль пользователя{% endblock %}
{% block content %}
<section class="course-page">
  <header class="course-header">
    <div class="course-author">
      <img class="course-author-avatar" src="{{ avatar }}" alt="Аватар {{ person.first_name or person.nickname or 'пользователя' }}">
      <div>
        <h1>{{ person.first_name or 'Профиль' }} {{ person.last_name or '' }}</h1>
        <div class="muted">@{{ person.nickname or 'без_ника' }} · {{ 'Специалист' if person.role=='specialist' else 'Ученик' }}</div>
      </div>
    </div>
    {% if selected_course %}
    <div class="course-header-meta">
      {% set course = selected_course.course %}
      <div class="badge accent">{{ course.subject or 'Без предмета' }}{% if course.topic %} · {{ course.topic }}{% endif %}</div>
      {% if course.price is not none %}
      <div class="price-pill">{{ format_price(course.price) }}</div>
      {% endif %}
    </div>
    {% endif %}
  </header>

  <div class="course-layout">
    <div class="course-main">
      {% if selected_course %}
      {% set course = selected_course.course %}
      {% set first_lesson = selected_course.lessons[0] if selected_course.lessons else None %}
      {% set first_source = first_lesson.sources[0] if first_lesson else None %}
      {% set access = selected_course.access %}
      <div class="course-hero">
        <div class="course-hero-left">
          <h2>{{ course.title }}</h2>
          <p class="muted">Последнее обновление · {{ (course.created_at.strftime('%d.%m.%Y') if course.created_at else '') }}</p>
          <div class="accordion-group" data-accordion-group>
            <div class="accordion-item open" data-accordion-item>
              <button class="accordion-toggle" type="button">Описание</button>
              <div class="accordion-content">
                {% if course.description %}
                <p>{{ course.description }}</p>
                {% else %}
                <p class="muted">Автор ещё не добавил описание к интенсиву.</p>
                {% endif %}
              </div>
            </div>
            <div class="accordion-item" data-accordion-item>
              <button class="accordion-toggle" type="button">О специалисте</button>
              <div class="accordion-content">
                <ul class="about-list">
                  <li><strong>Имя:</strong> {{ person.first_name or '—' }} {{ person.last_name or '' }}</li>
                  <li><strong>Возраст:</strong> {{ person.age or '—' }}</li>
                  <li><strong>Образование:</strong> {{ person.education or '—' }}</li>
                  <li><strong>Год выпуска:</strong> {{ person.graduation_year or '—' }}</li>
                  <li><strong>Ключевые навыки:</strong> {{ person.specialist.keywords if person.specialist else '—' }}</li>
                  <li><strong>Telegram:</strong> {{ person.telegram or '—' }}</li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div class="course-hero-right">
          <div class="hero-cover">
            {% if course.cover_image %}
            <img src="{{ course.cover_image }}" alt="Обложка {{ course.title }}">
            {% else %}
            <div class="cover-placeholder">Изображение появится после загрузки</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="course-player{% if not access.has_access %} locked{% endif %}" data-player {% if not access.has_access %}data-locked="1"{% endif %} data-course-id="{{ course.id }}" data-telegram="{{ person.telegram or '' }}">
        <video {% if access.has_access %}controls controlsList="nodownload" preload="metadata"{% else %}preload="none" muted{% endif %} data-video oncontextmenu="return false;">
          {% if access.has_access and first_source %}
          <source src="{{ first_source.src }}">
          {% endif %}
        </video>
        {% if access.has_access %}
        <div class="player-toolbar">
          <div class="player-controls">
            {% if first_lesson %}
            <label>Качество
              <select data-quality-select>
                {% for source in first_lesson.sources %}
                <option value="{{ source.src }}">{{ source.quality }}</option>
                {% endfor %}
              </select>
            </label>
            {% endif %}
          </div>
          <div class="player-actions">
            <a class="btn outline" data-download-target {% if first_source %}href="{{ first_source.download }}"{% else %}href="#"{% endif %} target="_blank" rel="noopener">Скачать материалы</a>
          </div>
        </div>
        {% else %}
        <div class="player-lock">
          {% set telegram_handle = (person.telegram or '').strip() %}
          {% set telegram_url = 'https://t.me/' + telegram_handle.lstrip('@') if telegram_handle else None %}
          {% if access.requires_student_login %}
          <div class="player-lock-content">
            <h3>Необходимо войти как ученик</h3>
            <p class="muted">Чтобы получить доступ к интенсиву, выйдите и авторизуйтесь в роли ученика.</p>
            <a class="btn outline" href="{{ url_for('logout') }}">
              <svg class="icon" viewBox="0 0 24 24" aria-hidden="true"><path d="M5 4h7v2H7v12h5v2H5a1 1 0 0 1-1-1V5a1 1 0 0 1 1-1Zm11.59 1.59L20 9l-3.41 3.41L15.17 11l1.59-1.59H10v-2h6.76L15.17 6 16.59 4.59Z"/></svg>
              Выйти
            </a>
          </div>
          {% elif access.pending %}
          <div class="player-lock-content">
            <h3>Заявка на рассмотрении</h3>
            <p>Мы уже отправили специалисту уведомление о вашем запросе.{% if telegram_handle %} Для оплаты свяжитесь со специалистом в Telegram <a href="{{ telegram_url }}" target="_blank" rel="noopener">{{ telegram_handle }}</a>.{% else %} Для оплаты свяжитесь со специалистом, когда он ответит на вашу заявку.{% endif %}</p>
            {% if not telegram_handle %}
            <p class="muted small">Специалист ещё не указал контакт в Telegram. Напишите ему в чат или дождитесь новых уведомлений.</p>
            {% endif %}
            <p class="muted">Курс откроется после подтверждения оплаты.</p>
          </div>
          {% elif access.status == 'declined' %}
          <div class="player-lock-content">
            <h3>Доступ закрыт</h3>
            <p>К сожалению, специалист отклонил вашу заявку на этот интенсив.</p>
            <a class="btn outline" href="{{ url_for('search') }}">Искать новые курсы</a>
          </div>
          {% else %}
          <div class="player-lock-content">
            <h3>Видео заблокировано</h3>
            <p>Приобретите курс, чтобы получить полный доступ к материалам.</p>
            <button class="btn strong" type="button" data-purchase-button data-course-id="{{ course.id }}">Приобрести курс</button>
          </div>
          {% endif %}
        </div>
        {% endif %}
      </div>

      {% if selected_course.lessons %}
      <div class="lesson-rail{% if not access.has_access %} locked{% endif %}" data-lesson-rail>
        <h3>Все уроки</h3>
        <div class="lesson-scroll">
          {% for lesson in selected_course.lessons %}
          <button class="lesson-card {% if loop.first %}active{% endif %}" type="button" data-sources='{{ lesson.sources | tojson }}'>
            <span class="lesson-index">{{ loop.index }}</span>
            <span class="lesson-title">{{ lesson.title }}</span>
          </button>
          {% endfor %}
        </div>
      </div>
      {% else %}
      <div class="course-placeholder">В этом интенсиве пока нет загруженных видео.</div>
      {% endif %}
      {% else %}
      <div class="course-placeholder">Специалист ещё не добавил интенсив.</div>
      {% endif %}
    </div>

    <aside class="course-side">
      <div class="side-card">
        <h3>Интенсивы специалиста</h3>
        {% if courses %}
        <div class="side-courses">
          {% for payload in courses %}
          {% set course = payload.course %}
          <a class="side-course {% if selected_course and selected_course.course.id == course.id %}active{% endif %}" href="{{ url_for('public_profile', user_id=person.id, course_id=course.id) }}">
            <div class="side-thumb" {% if course.cover_image %}style="background-image:url('{{ course.cover_image }}')"{% endif %}></div>
            <div class="side-info">
              <div class="side-title">{{ course.title }}</div>
              <div class="muted small">{{ course.subject or 'Без предмета' }}{% if course.topic %} · {{ course.topic }}{% endif %}</div>
            </div>
          </a>
          {% endfor %}
        </div>
        {% else %}
        <p class="muted small">Здесь появятся опубликованные интенсивы.</p>
        {% endif %}
      </div>
      <div class="side-card compact">
        <h3>Контакты</h3>
        <ul class="side-list">
          <li><strong>Telegram:</strong> {{ person.telegram or '—' }}</li>
          <li><strong>Email:</strong> {{ person.email }}</li>
        </ul>
      </div>
    </aside>
  </div>
</section>
<div class="purchase-modal" data-purchase-modal hidden>
  <div class="purchase-modal-card">
    <h3>Мы отправили специалисту о вашей заявке</h3>
    <p data-purchase-contact>Для оплаты свяжитесь со специалистом <a href="#" target="_blank" rel="noopener" data-purchase-telegram>в Telegram</a>.</p>
    <p class="muted small" data-purchase-contact-fallback hidden>Специалист пока не указал контакт в Telegram. Напишите ему в чат или дождитесь новых уведомлений.</p>
    <p>Курс откроется после того как специалист подтвердит оплату.</p>
    <div class="purchase-modal-actions">
      <button class="btn strong" type="button" data-purchase-close>Понятно</button>
    </div>
  </div>
</div>
{% endblock %}
